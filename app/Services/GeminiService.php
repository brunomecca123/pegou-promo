<?php

namespace App\Services;

use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;

class GeminiService
{
    protected $apiKey;
    protected $baseUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent';

    public function __construct()
    {
        $this->apiKey = config('services.gemini.api_key', env('GEMINI_API_KEY'));
    }

    public function generatePromotionPost(array $promotionData)
    {
        try {
            $prompt = $this->buildPromotionPrompt($promotionData);
            
            $response = Http::withHeaders([
                'Content-Type' => 'application/json',
                'x-goog-api-key' => $this->apiKey
            ])->timeout(30)->post($this->baseUrl, [
                'contents' => [
                    [
                        'role' => 'user',
                        'parts' => [
                            [
                                'text' => $prompt
                            ]
                        ]
                    ]
                ],
                'generationConfig' => [
                    'temperature' => 0.7,
                    'topP' => 0.9,
                    'maxOutputTokens' => 1000
                ]
            ]);

            if (!$response->successful()) {
                Log::error('Erro na API do Gemini: ' . $response->body());
                return null;
            }

            $data = $response->json();
            
            if (isset($data['candidates'][0]['content']['parts'][0]['text'])) {
                return trim($data['candidates'][0]['content']['parts'][0]['text']);
            }

            return null;

        } catch (\Exception $e) {
            Log::error('Erro ao gerar post com Gemini: ' . $e->getMessage());
            return null;
        }
    }

    protected function buildPromotionPrompt(array $promotion)
    {
        $prompt = "Voc√™ √© um especialista em marketing de afiliados e cria√ß√£o de conte√∫do para redes sociais, especificamente para canais de promo√ß√µes no Telegram e WhatsApp.\n\n";
        
        $prompt .= "DADOS DA PROMO√á√ÉO:\n";
        $prompt .= "‚Ä¢ Produto: {$promotion['title']}\n";
        $prompt .= "‚Ä¢ Loja: {$promotion['store']}\n";
        
        if (isset($promotion['original_price']) && $promotion['original_price']) {
            $prompt .= "‚Ä¢ Pre√ßo Original: R$ " . number_format($promotion['original_price'], 2, ',', '.') . "\n";
        }
        
        if (isset($promotion['discounted_price']) && $promotion['discounted_price']) {
            $prompt .= "‚Ä¢ Pre√ßo com Desconto: R$ " . number_format($promotion['discounted_price'], 2, ',', '.') . "\n";
        }
        
        if (isset($promotion['discount_percentage']) && $promotion['discount_percentage']) {
            $prompt .= "‚Ä¢ Desconto: {$promotion['discount_percentage']}%\n";
        }
        
        if (isset($promotion['description']) && $promotion['description']) {
            $prompt .= "‚Ä¢ Descri√ß√£o: {$promotion['description']}\n";
        }
        
        if (isset($promotion['category']) && $promotion['category']) {
            $prompt .= "‚Ä¢ Categoria: {$promotion['category']}\n";
        }

        // Incluir link de afiliado se dispon√≠vel
        if (isset($promotion['affiliate_url']) && !empty($promotion['affiliate_url'])) {
            $prompt .= "‚Ä¢ Link de Compra: {$promotion['affiliate_url']}\n";
        } elseif (isset($promotion['url']) && !empty($promotion['url'])) {
            $prompt .= "‚Ä¢ Link de Compra: {$promotion['url']}\n";
        }

        $prompt .= "\nCRIE UM POST ATRATIVO SEGUINDO ESTAS DIRETRIZES:\n\n";
        
        $prompt .= "üéØ ESTRUTURA OBRIGAT√ìRIA:\n";
        $prompt .= "1. T√çTULO CHAMATIVO com emoji relevante\n";
        $prompt .= "2. DESTAQUE DO DESCONTO (se houver)\n";
        $prompt .= "3. CARACTER√çSTICAS PRINCIPAIS do produto (m√°ximo 3 pontos)\n";
        $prompt .= "4. LINK DE COMPRA (use o link fornecido acima)\n";
        $prompt .= "5. CALL TO ACTION motivador\n";
        $prompt .= "6. HASHTAGS relevantes (m√°ximo 3)\n\n";
        
        $prompt .= "üìù REGRAS DE ESCRITA:\n";
        $prompt .= "‚Ä¢ Use linguagem informal e entusiasmada\n";
        $prompt .= "‚Ä¢ M√°ximo 300 caracteres (sem contar o link)\n";
        $prompt .= "‚Ä¢ Use emojis estrategicamente (n√£o exagere)\n";
        $prompt .= "‚Ä¢ Crie urg√™ncia sem ser invasivo\n";
        $prompt .= "‚Ä¢ Foque nos benef√≠cios para o consumidor\n";
        $prompt .= "‚Ä¢ Use termos como 'IMPERD√çVEL', 'OFERTA LIMITADA', 'PRE√áO HIST√ìRICO'\n";
        $prompt .= "‚Ä¢ SEMPRE inclua o link de compra fornecido no post\n\n";
        
        $prompt .= "ÔøΩ INCLUIR LINK (VARIE A APRESENTA√á√ÉO):\n";
        $prompt .= "‚Ä¢ O link deve ser inclu√≠do na mensagem de forma natural e VARIADA\n";
        $prompt .= "‚Ä¢ ALTERNE entre estas op√ß√µes de call-to-action:\n";
        $prompt .= "  - 'üõí Compre aqui:'\n";
        $prompt .= "  - 'üëá Garanta o seu:'\n";
        $prompt .= "  - 'üî• Aproveite:'\n";
        $prompt .= "  - '‚ö° Link direto:'\n";
        $prompt .= "  - 'üéØ Adquira j√°:'\n";
        $prompt .= "  - 'üí• Oferta aqui:'\n";
        $prompt .= "  - 'üöÄ Corre l√°:'\n";
        $prompt .= "  - '‚ú® Pegue o seu:'\n";
        $prompt .= "  - 'üèÉ‚Äç‚ôÇÔ∏è Voa:'\n";
        $prompt .= "  - 'üîó Link da promo√ß√£o:'\n";
        $prompt .= "‚Ä¢ VARIE tamb√©m a posi√ß√£o do link:\n";
        $prompt .= "  - √Äs vezes ap√≥s as caracter√≠sticas\n";
        $prompt .= "  - √Äs vezes antes do call-to-action final\n";
        $prompt .= "  - √Äs vezes integrado no meio do texto\n";
        $prompt .= "‚Ä¢ Use SEMPRE emojis diferentes para o link\n";
        $prompt .= "‚Ä¢ Seja criativo na apresenta√ß√£o, mas mantenha o link completo\n\n";
        
        $prompt .= "üö´ N√ÉO FA√áA:\n";
        $prompt .= "‚Ä¢ N√£o modifique ou encurte o link fornecido\n";
        $prompt .= "‚Ä¢ N√£o use sempre a mesma apresenta√ß√£o do link\n";
        $prompt .= "‚Ä¢ N√£o use termos duvidosos ou spam\n";
        $prompt .= "‚Ä¢ N√£o inclua informa√ß√µes n√£o confirmadas\n";
        $prompt .= "‚Ä¢ N√£o fa√ßa compara√ß√µes com concorrentes\n\n";
        
        $prompt .= "üí° EXEMPLOS DE VARIA√á√ïES DO LINK:\n";
        $prompt .= "Exemplo 1:\n";
        $prompt .= "\"üî• PRE√áO HIST√ìRICO! iPhone 15 com 67% OFF\n";
        $prompt .= "‚úÖ C√¢mera 48MP\n";
        $prompt .= "‚úÖ Chip A17 Pro\n";
        $prompt .= "üõí Compre aqui: [LINK]\n";
        $prompt .= "‚ö° CORRE QUE ACABA! #iPhone\"\n\n";
        
        $prompt .= "Exemplo 2:\n";
        $prompt .= "\"üéÆ GAMER, CHEGOU A HORA!\n";
        $prompt .= "‚úÖ Headset HyperX 45% OFF\n";
        $prompt .= "üî• Aproveite: [LINK]\n";
        $prompt .= "‚úÖ Som surround 7.1\n";
        $prompt .= "üéØ √öltima chance! #Gaming\"\n\n";
        
        $prompt .= "Exemplo 3:\n";
        $prompt .= "\"‚ú® Echo Dot com desconto INSANO!\n";
        $prompt .= "‚úÖ Alexa integrada\n";
        $prompt .= "‚úÖ Casa inteligente\n";
        $prompt .= "‚ö° Link direto: [LINK]\n";
        $prompt .= "üí• Voando! #SmartHome\"\n\n";
        
        $prompt .= "Agora crie um post VARIANDO a apresenta√ß√£o do link e seguindo esse padr√£o para a promo√ß√£o informada:";

        return $prompt;
    }

    public function generateVariations(string $originalPost, int $count = 3)
    {
        try {
            $prompt = "Voc√™ recebeu este post de promo√ß√£o:\n\n\"$originalPost\"\n\n";
            $prompt .= "Crie $count varia√ß√µes diferentes deste post mantendo:\n";
            $prompt .= "‚Ä¢ A mesma informa√ß√£o essencial\n";
            $prompt .= "‚Ä¢ O tom entusiasmado\n";
            $prompt .= "‚Ä¢ A estrutura com emojis\n";
            $prompt .= "‚Ä¢ M√°ximo 200 caracteres cada\n\n";
            $prompt .= "Mas mudando:\n";
            $prompt .= "‚Ä¢ As palavras de call-to-action\n";
            $prompt .= "‚Ä¢ Os emojis usados\n";
            $prompt .= "‚Ä¢ A ordem das informa√ß√µes\n\n";
            $prompt .= "Retorne apenas as varia√ß√µes, uma por linha, numeradas.";

            $response = Http::withHeaders([
                'Content-Type' => 'application/json',
                'x-goog-api-key' => $this->apiKey
            ])->timeout(30)->post($this->baseUrl, [
                'contents' => [
                    [
                        'role' => 'user',
                        'parts' => [
                            [
                                'text' => $prompt
                            ]
                        ]
                    ]
                ],
                'generationConfig' => [
                    'temperature' => 0.8,
                    'topP' => 0.95,
                    'maxOutputTokens' => 800
                ]
            ]);

            if (!$response->successful()) {
                Log::error('Erro na API do Gemini para varia√ß√µes: ' . $response->body());
                return [];
            }

            $data = $response->json();
            
            if (isset($data['candidates'][0]['content']['parts'][0]['text'])) {
                $text = trim($data['candidates'][0]['content']['parts'][0]['text']);
                // Dividir as varia√ß√µes por linha e limpar
                $variations = array_map('trim', explode("\n", $text));
                return array_filter($variations, function($v) { 
                    return !empty($v) && strlen($v) > 20; 
                });
            }

            return [];

        } catch (\Exception $e) {
            Log::error('Erro ao gerar varia√ß√µes com Gemini: ' . $e->getMessage());
            return [];
        }
    }

    public function optimizePost(string $post, string $platform = 'telegram')
    {
        try {
            $platformRules = [
                'telegram' => 'Telegram (permite formata√ß√£o HTML b√°sica, at√© 4096 caracteres)',
                'whatsapp' => 'WhatsApp (sem formata√ß√£o especial, at√© 65536 caracteres)',
                'instagram' => 'Instagram (com hashtags obrigat√≥rias, at√© 2200 caracteres)'
            ];

            $prompt = "Otimize este post de promo√ß√£o para {$platformRules[$platform]}:\n\n";
            $prompt .= "\"$post\"\n\n";
            $prompt .= "Mantenha o conte√∫do essencial mas adapte para as melhores pr√°ticas da plataforma.";

            $response = Http::withHeaders([
                'Content-Type' => 'application/json',
                'x-goog-api-key' => $this->apiKey
            ])->timeout(30)->post($this->baseUrl, [
                'contents' => [
                    [
                        'role' => 'user',
                        'parts' => [
                            [
                                'text' => $prompt
                            ]
                        ]
                    ]
                ]
            ]);

            if (!$response->successful()) {
                return $post; // Retorna o original se falhar
            }

            $data = $response->json();
            
            if (isset($data['candidates'][0]['content']['parts'][0]['text'])) {
                return trim($data['candidates'][0]['content']['parts'][0]['text']);
            }

            return $post;

        } catch (\Exception $e) {
            Log::error('Erro ao otimizar post com Gemini: ' . $e->getMessage());
            return $post;
        }
    }
}
